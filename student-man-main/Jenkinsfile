pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
        // skipDefaultCheckout(true)
    }


    environment {
        REGISTRY = "ghaith6789"
        IMAGE = "student_app_management"
        SONAR_HOST_URL = "http://192.168.33.10:9000"
        APP_DAST_URL   = "http://192.168.49.2:32639"

        GITLEAKS_REPORT = "gitleaks-report.json"
    }

    stages {

        stage('Clean Workspace') {
            steps {
                cleanWs()
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/ghaithelbenna/students-management-devops.git'
            }
        }

        stage('Secrets Scan (Gitleaks)') {
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "üîí Running Gitleaks Secrets Scan..."
                    set +e
                    gitleaks detect --source . \
                      --report-format json \
                      --report-path "$GITLEAKS_REPORT" \
                      --verbose
                    EXIT=$?
                    set -e

                    if [ $EXIT -ne 0 ] && [ $EXIT -ne 1 ]; then
                      echo "‚ùå Gitleaks failed with exit code $EXIT"
                      exit $EXIT
                    fi

                    if [ ! -s "$GITLEAKS_REPORT" ]; then
                      echo "[]" > "$GITLEAKS_REPORT"
                    fi
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "student-man-main/${GITLEAKS_REPORT}", allowEmptyArchive: false
                }
            }
        }

        stage('Build with Maven') {
            steps {
                dir('student-man-main') {
                    sh 'mvn -B clean package -DskipTests'
                }
            }
        }

        stage('Dependency Check (SCA)') {
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "üîç Running lightweight OWASP Dependency-Check..."
                    mvn -B org.owasp:dependency-check-maven:check \
                        -Dformat=HTML \
                        -DskipAssembly=true || true
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/target/dependency-check-report.html', allowEmptyArchive: true
                }
            }
        }

        stage('SonarQube (SAST)') {
            environment {
                SONARQUBE = credentials('sonarqube-token')
            }
            steps {
                dir('student-man-main') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                        echo "üìä Running SonarQube static code analysis..."
                        mvn -B sonar:sonar \
                          -Dsonar.projectKey=studentmang-app \
                          -Dsonar.host.url=${SONAR_HOST_URL} \
                          -Dsonar.login=$SONARQUBE || true
                        '''
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('student-man-main') {
                    sh 'docker build -t $REGISTRY/$IMAGE:latest .'
                }
            }
        }

        stage('Trivy Scan (Container Security)') {
            environment {
                TRIVY_CACHE_DIR = "${WORKSPACE}/.trivycache"
            }
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "‚¨áÔ∏è Pre-downloading Trivy DB..."
                    trivy image --download-db-only || true

                    echo "‚¨áÔ∏è Pre-downloading Trivy Java DB..."
                    trivy image --download-java-db-only || true

                    echo "üß™ Running Trivy vulnerability scan (vuln only)..."

                    (while true; do echo "[trivy] scanning... $(date)"; sleep 30; done) &
                    KEEPALIVE_PID=$!

                    trivy image --scanners vuln \
                      --severity HIGH,CRITICAL \
                      --timeout 15m \
                      --format table \
                      --output trivy-report.html \
                      $REGISTRY/$IMAGE:latest || true

                    kill $KEEPALIVE_PID
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/trivy-report.html', allowEmptyArchive: true
                }
            }
        }

        stage('Nikto Scan (DAST)') {
            steps {
                dir('student-man-main') {
                    sh '''
                    echo "üí• Running Nikto web vulnerability scan on $APP_DAST_URL..."
                    nikto -h $APP_DAST_URL -maxtime 60 -Format html -o nikto-report.html || true
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/nikto-report.html', allowEmptyArchive: true
                }
            }
        }

        stage('Push to Docker Hub') {
            steps {
                dir('student-man-main') {
                    withCredentials([usernamePassword(credentialsId: 'dockerhub', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push $REGISTRY/$IMAGE:latest || true
                        docker logout
                        '''
                    }
                }
            }
        }

        stage('Generate Summary Report') {
            steps {
                script {
                    def time = sh(script: "date", returnStdout: true).trim()
                    writeFile file: 'student-man-main/summary-report.html', text: """
                    <html><head><title>DevSecOps Report</title></head><body>
                        <h2>‚úÖ DevSecOps Security Pipeline Summary</h2>
                        <ul>
                            <li><a href='target/dependency-check-report.html'>Dependency Check Report (SCA)</a></li>
                            <li><a href='trivy-report.html'>Trivy Image Scan Report (Container)</a></li>
                            <li><a href='nikto-report.html'>Nikto Server Scan Report (DAST)</a></li>
                            <li><a href='${GITLEAKS_REPORT}'>Gitleaks Secrets Scan Report</a></li>
                            <li><a href='${SONAR_HOST_URL}/dashboard?id=studentmang-app'>SonarQube Dashboard (SAST)</a></li>
                        </ul>
                        <p>Generated by Jenkins on ${time}</p>
                    </body></html>
                    """
                }
                archiveArtifacts artifacts: 'student-man-main/summary-report.html', allowEmptyArchive: true
            }
        }
    }

    post {
        always {
            echo 'üéØ Pipeline finished. Reports generated successfully.'

            emailext(
                subject: "Pipeline Status: ${currentBuild.currentResult} - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """<html>
  <body>
    <h3>DevSecOps Pipeline Result</h3>
    <p><b>Status:</b> ${currentBuild.currentResult}</p>
    <p><b>Job:</b> ${env.JOB_NAME}</p>
    <p><b>Build Number:</b> ${env.BUILD_NUMBER}</p>
    <p><b>Build URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
    <p>Reports are archived in Jenkins workspace.</p>
  </body>
</html>""",
                to: "ghaithelbenna2@gmail.com",
                from: "jenkins@example.com",
                replyTo: "jenkins@example.com",
                mimeType: "text/html",
                attachmentsPattern: """student-man-main/target/dependency-check-report.html,
student-man-main/trivy-report.html,
student-man-main/nikto-report.html,
student-man-main/${GITLEAKS_REPORT},
student-man-main/summary-report.html""",
                compressAttachments: true
            )
        }

        failure {
            echo '‚ùå  Pipeline failed. Please check logs and reports for issues.'
        }
    }
}
