pipeline {
    agent any

    options {
        disableConcurrentBuilds()
        timestamps()
        timeout(time: 40, unit: 'MINUTES')
    }

    environment {
        REGISTRY = "ghaith6789"
        IMAGE    = "student_app_management"

        DOCKER_IMAGE        = "${REGISTRY}/${IMAGE}:${BUILD_NUMBER}"
        DOCKER_IMAGE_LATEST = "${REGISTRY}/${IMAGE}:latest"

        SONAR_HOST_URL = "http://192.168.33.10:9000"
        APP_DAST_URL   = "http://localhost:8080"

        GITLEAKS_REPORT = "gitleaks-report.json"

        TRIVY_CACHE_DIR = "${WORKSPACE}/.trivycache"
        TRIVY_TMP_DIR   = "${WORKSPACE}/.trivytmp"

        APP_CONTAINER = "app-zap-${BUILD_NUMBER}"
        ZAP_NETWORK   = "zap-net-${BUILD_NUMBER}"
    }

    stages {

        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Checkout') {
            steps {
                git branch: 'master',
                    url: 'https://github.com/ghaithelbenna/students-management-devops.git'
            }
        }

        stage('Secrets Scan (Gitleaks)') {
            steps {
                dir('student-man-main') {
                    sh """
                        echo "ðŸ”’ Running Gitleaks..."
                        gitleaks detect --source . \
                          --redact \
                          --exit-code 1 \
                          --report-format json \
                          --report-path "$GITLEAKS_REPORT"
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: "student-man-main/${GITLEAKS_REPORT}",
                                     allowEmptyArchive: false
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('student-man-main') {
                    sh 'mvn -B clean test'
                }
            }
            post {
                always {
                    junit testResults: 'student-man-main/target/surefire-reports/*.xml',
                          allowEmptyResults: false
                }
            }
        }

        stage('Build with Maven') {
            steps {
                dir('student-man-main') {
                    sh 'mvn -B clean package -DskipTests'
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/target/*.jar',
                                     allowEmptyArchive: false
                }
            }
        }

        stage('Dependency Check (SCA)') {
            steps {
                dir('student-man-main') {
                    sh '''
                        echo "ðŸ” Running OWASP Dependency-Check..."
                        mvn -B org.owasp:dependency-check-maven:check \
                            -Dformat=HTML \
                            -DfailBuildOnCVSS=7
                    '''
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/target/dependency-check-report.html',
                                     allowEmptyArchive: false
                }
            }
        }

        stage('SonarQube (SAST)') {
            environment {
                SONAR_TOKEN = credentials('sonarqube-token')
            }
            steps {
                dir('student-man-main') {
                    withSonarQubeEnv('SonarQube') {
                        sh '''
                            echo "ðŸ“Š Running SonarQube..."
                            mvn -B sonar:sonar \
                              -Dsonar.projectKey=studentmang-app \
                              -Dsonar.host.url=$SONAR_HOST_URL \
                              -Dsonar.login=$SONAR_TOKEN
                        '''
                    }
                }
            }
        }

        stage('Quality Gate') {
            steps {
                script {
                    timeout(time: 10, unit: 'MINUTES') {
                        def qg = waitForQualityGate()
                        echo "âœ… Quality Gate status: ${qg.status}"
                        if (qg.status != 'OK') {
                            error "âŒ Pipeline stopped: Quality Gate = ${qg.status}"
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('student-man-main') {
                    sh "docker build -t ${DOCKER_IMAGE} ."
                    sh "docker tag ${DOCKER_IMAGE} ${DOCKER_IMAGE_LATEST}"
                }
            }
        }
stage('Trivy Scan (Container Security)') {
    steps {
        dir('student-man-main') {
            sh """
                mkdir -p ${TRIVY_CACHE_DIR} ${TRIVY_TMP_DIR}
                export TMPDIR=${TRIVY_TMP_DIR}

                echo "ðŸ›¡ï¸ Running Trivy..."
                trivy image \
                  --scanners vuln \
                  --cache-dir ${TRIVY_CACHE_DIR} \
                  --severity HIGH,CRITICAL \
                  --exit-code 1 \
                  --timeout 30m \
                  --no-progress \
                  --format html \
                  --output trivy-report.html \
                  ${DOCKER_IMAGE}
            """
        }
    }
    post {
        always {
            archiveArtifacts artifacts: 'student-man-main/trivy-report.html',
                             allowEmptyArchive: false
        }
    }
}


        stage('Deploy Staging for DAST') {
            steps {
                script {
                    def appContainer = "app-test-${env.BUILD_NUMBER}"

                    // clean sans masquer dâ€™erreur sÃ©curitÃ©
                    sh "docker rm -f ${appContainer} || docker ps -a | grep ${appContainer} || true"

                    sh """
                        docker run -d --name ${appContainer} -p 8080:8080 ${DOCKER_IMAGE}
                        echo "Waiting for app..."
                        timeout 120 bash -c 'until curl -f ${APP_DAST_URL}/ >/dev/null 2>&1; do sleep 5; done'
                    """
                }
            }
        }

        stage('Nikto Scan (DAST)') {
            steps {
                dir('student-man-main') {
                    sh """
                        echo "ðŸ’¥ Running Nikto..."
                        nikto -h ${APP_DAST_URL} \
                          -maxtime 120 \
                          -Format html \
                          -o nikto-report.html
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/nikto-report.html',
                                     allowEmptyArchive: false
                }
            }
        }

        stage('DAST - OWASP ZAP') {
            steps {
                dir('student-man-main') {
                    sh """
                        APP=${APP_CONTAINER}
                        NET=${ZAP_NETWORK}
                        IMG=${DOCKER_IMAGE}

                        docker network create \$NET
                        docker run -d --network \$NET --name \$APP \$IMG

                        timeout 120 bash -c "until curl -f http://\$APP:8080 >/dev/null 2>&1; do sleep 5; done" || echo "App not ready, scanning anyway"

                        docker run --rm --network \$NET \
                          -v "\$(pwd):/zap/wrk" \
                          -t zaproxy/zap-stable \
                          zap-baseline.py \
                            -t http://\$APP:8080 \
                            -x /zap/wrk/zap-report.xml \
                            -r /zap/wrk/zap-report.html
                    """
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'student-man-main/zap-report.*',
                                     allowEmptyArchive: false
                }
            }
        }

        stage('Push to Docker Hub') {
            when { expression { currentBuild.currentResult == 'SUCCESS' } }
            steps {
                dir('student-man-main') {
                    withCredentials([usernamePassword(
                        credentialsId: 'dockerhub',
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh """
                            echo "\$DOCKER_PASS" | docker login -u "\$DOCKER_USER" --password-stdin
                            docker push ${DOCKER_IMAGE}
                            docker push ${DOCKER_IMAGE_LATEST}
                            docker logout
                        """
                    }
                }
            }
        }

        stage('Generate Summary Report') {
            steps {
                script {
                    def time = sh(script: "date", returnStdout: true).trim()
                    writeFile file: 'student-man-main/summary-report.html', text: """
                    <html><head><title>DevSecOps Report</title></head><body>
                        <h2>âœ… DevSecOps Security Pipeline Summary</h2>
                        <ul>
                            <li><a href='target/dependency-check-report.html'>Dependency Check (SCA)</a></li>
                            <li><a href='trivy-report.html'>Trivy Scan</a></li>
                            <li><a href='nikto-report.html'>Nikto DAST</a></li>
                            <li><a href='zap-report.html'>OWASP ZAP DAST</a></li>
                            <li><a href='${GITLEAKS_REPORT}'>Gitleaks</a></li>
                            <li><a href='${SONAR_HOST_URL}/dashboard?id=studentmang-app'>SonarQube</a></li>
                        </ul>
                        <p>Generated by Jenkins on ${time}</p>
                    </body></html>
                    """
                }
                archiveArtifacts artifacts: 'student-man-main/summary-report.html',
                                 allowEmptyArchive: false
            }
        }
    }

    post {
        always {
            echo "ðŸŽ¯ Pipeline finished."

            script {
                def appContainer = "app-test-${env.BUILD_NUMBER}"
                sh "docker rm -f ${appContainer} || true"
            }

            sh """
                docker rm -f ${APP_CONTAINER} || true
                docker network rm ${ZAP_NETWORK} || true
            """

            emailext(
                subject: "Pipeline Status: ${currentBuild.currentResult} - ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: """<html><body>
                    <h3>DevSecOps Pipeline Result</h3>
                    <p><b>Status:</b> ${currentBuild.currentResult}</p>
                    <p><b>Job:</b> ${env.JOB_NAME}</p>
                    <p><b>Build Number:</b> ${env.BUILD_NUMBER}</p>
                    <p><b>Build URL:</b> <a href="${env.BUILD_URL}">${env.BUILD_URL}</a></p>
                </body></html>""",
                to: "ghaithelbenna2@gmail.com",
                mimeType: "text/html",
                attachmentsPattern: """student-man-main/target/dependency-check-report.html,
student-man-main/trivy-report.html,
student-man-main/nikto-report.html,
student-man-main/zap-report.html,
student-man-main/zap-report.xml,
student-man-main/${GITLEAKS_REPORT},
student-man-main/summary-report.html"""
            )
        }
    }
}
