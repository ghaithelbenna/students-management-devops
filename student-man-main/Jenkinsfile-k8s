pipeline {
    agent any

    environment {
        PATH = "/usr/local/bin:${PATH}"
        REPORT_DIR = "reports"
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/medaminehammami/student-management-devops.git'
                sh 'mkdir -p ${REPORT_DIR}'
            }
        }

        stage('KubeLinter Scan') {
            steps {
                echo 'üîç Running KubeLinter...'
                sh '''
                    echo "<h2>KubeLinter Security Report</h2><pre>" > ${REPORT_DIR}/kube-linter-report.html
                    kube-linter lint student-man-main/k8s/ >> ${REPORT_DIR}/kube-linter-report.html 2>&1 || true
                    echo "</pre>" >> ${REPORT_DIR}/kube-linter-report.html
                '''
            }
        }

        stage('Kubescape Scan') {
            steps {
                echo 'üõ°Ô∏è Running Kubescape...'
                sh '''
                    echo "<h2>Kubescape NSA Framework Report</h2><pre>" > ${REPORT_DIR}/kubescape-report.html
                    kubescape scan framework nsa --use-host-network --format table >> ${REPORT_DIR}/kubescape-report.html 2>&1 || true
                    echo "</pre>" >> ${REPORT_DIR}/kubescape-report.html
                '''
            }
        }

        stage('Generate Summary Report') {
            steps {
                echo 'üìä Combining reports...'
                sh '''
                    echo "<html><head><title>Kubernetes Security Scan</title></head><body>" > ${REPORT_DIR}/index.html
                    echo "<h1>Kubernetes Security Scan Summary</h1>" >> ${REPORT_DIR}/index.html
                    cat ${REPORT_DIR}/kube-linter-report.html >> ${REPORT_DIR}/index.html
                    cat ${REPORT_DIR}/kubescape-report.html >> ${REPORT_DIR}/index.html
                    echo "</body></html>" >> ${REPORT_DIR}/index.html
                '''
            }
        }
    }

    post {
        always {
            echo '‚úÖ Security scans completed. Reports saved in Jenkins artifacts.'
            archiveArtifacts artifacts: 'reports/*.html', fingerprint: true
            publishHTML(target: [
                allowMissing: false,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'index.html',
                reportName: 'Kubernetes Security Scan'
            ])
        }
    }
}
